<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modbus Slave Configuration</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="slaves.css">
</head>
<body class="dark-mode">
    <div class="app-container">
        <header class="app-header">
            <div class="header-content">
                <h1 class="app-title">ESP8266 Configuration Portal</h1>
            </div>
        </header>

        <nav class="main-nav">
            <div class="nav-container">
                <a href="/" class="nav-item" data-tab="wifi">
                    <span class="nav-icon">üì∂</span>
                    <span class="nav-text">WiFi Configuration</span>
                </a>
                <a href="/slaves.html" class="nav-item active" data-tab="slaves">
                    <span class="nav-icon">üîß</span>
                    <span class="nav-text">Modbus Slaves</span>
                </a>
                <a href="/settings.html" class="nav-item" data-tab="settings">
                    <span class="nav-icon">‚öôÔ∏è</span>
                    <span class="nav-text">Settings</span>
                </a>
                <a href="/debug.html" class="nav-item" data-tab="debug">
                    <span class="nav-icon">üêõ</span>
                    <span class="nav-text">Debug</span>
                </a>
            </div>
        </nav>

        <main class="main-content">
            <div class="content-header">
                <h2>Modbus RTU Slave Configuration</h2>
                <p class="content-description">Configure Modbus RTU slaves and global polling parameters</p>
            </div>

            <div class="status-message" id="status" aria-live="polite"></div>

            <div class="configuration-layout">
                <section class="config-panel" aria-labelledby="slave-management-heading">
                    <header class="panel-header">
                        <h3 id="slave-management-heading" class="panel-title">
                            <span class="panel-icon">‚ûï</span>
                            Add New Slave
                        </h3>
                    </header>

                    <form class="slave-form" id="slaveForm">
                        <div class="form-row">
                            <div class="input-group compact">
                                <label for="slave_id" class="input-label">Slave ID</label>
                                <input type="number" 
                                       id="slave_id" 
                                       class="text-input"
                                       placeholder="1"
                                       min="1" 
                                       max="247">
                            </div>

                            <div class="input-group compact">
                                <label for="start_reg" class="input-label">Start Register</label>
                                <input type="number" 
                                       id="start_reg" 
                                       class="text-input"
                                       placeholder="0"
                                       min="0" 
                                       max="65535">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="input-group compact">
                                <label for="num_reg" class="input-label">Register Count</label>
                                <input type="number" 
                                       id="num_reg" 
                                       class="text-input"
                                       placeholder="10"
                                       min="1" 
                                       max="125">
                            </div>
                        </div>

                        <div class="input-group">
                            <label for="slave_name" class="input-label">Slave Name</label>
                            <input type="text" 
                                   id="slave_name" 
                                   class="text-input"
                                   placeholder="Temperature Sensor 1">
                        </div>

                        <div class="input-group">
                            <label for="mqtt_topic" class="input-label">MQTT Topic</label>
                            <input type="text" 
                                   id="mqtt_topic" 
                                   class="text-input"
                                   placeholder="modbus/slave1/data">
                        </div>

                        <div class="action-bar compact dual-buttons">
                            <button type="button" class="btn btn-primary" onclick="addSlave()">
                                <span class="btn-icon">‚ûï</span>
                                Add Slave Device
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="loadSlaveConfig()">
                                <span class="btn-icon">üì•</span>
                                Load Slave
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="saveSlaveConfig()">
                                <span class="btn-icon">üíæ</span>
                                Save Slave
                            </button>
                        </div>
                    </form>

                    <!-- Moved Statistics Panel Here -->
                    <div class="stats-panel">
                        <h4 class="stats-title">System Statistics</h4>
                        <div class="stats-grid">
                            <div class="stat-item">
                                <span class="stat-label">Unique Slave IDs</span>
                                <span class="stat-value" id="slaveCount">0</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Total Entries</span>
                                <span class="stat-value" id="totalEntries">0</span>
                            </div>
                        </div>
                    </div>
                </section>

                <section class="config-panel" aria-labelledby="config-management-heading">

                    <!-- Updated Timeout Settings to match Polling Settings -->
                    <div class="polling-section">
                        <h4 class="section-title">Timeout Settings</h4>
                        <div class="input-group">
                            <label for="timeout" class="input-label">Timeout (seconds)</label>
                            <input type="number" 
                                id="timeout" 
                                class="text-input"
                                placeholder="1"
                                step="1">
                        </div>
                        <div class="action-stack">
                            <button class="btn btn-secondary full-width" onclick="loadTimeout()">
                                <span class="btn-icon">üì•</span>
                                Load Timeout
                            </button>
                            <button class="btn btn-primary full-width" onclick="saveTimeout()">
                                <span class="btn-icon">üíæ</span>
                                Save Timeout
                            </button>
                        </div>
                    </div>

                    <div class="polling-section">
                        <h4 class="section-title">Polling Settings</h4>
                        <div class="input-group">
                            <label for="poll_interval" class="input-label">Poll Interval (seconds)</label>
                            <input type="number" 
                                id="poll_interval" 
                                class="text-input"
                                placeholder="10">
                        </div>
                        <div class="action-stack">
                            <button class="btn btn-secondary full-width" onclick="loadPollInterval()">
                                <span class="btn-icon">üì•</span>
                                Load Poll Interval
                            </button>
                            <button class="btn btn-primary full-width" onclick="savePollInterval()">
                                <span class="btn-icon">‚è±Ô∏è</span>
                                Save Poll Interval
                            </button>
                        </div>
                    </div>
                </section>
            </div>

            <section class="slave-list-panel" aria-labelledby="slave-list-heading">
                <header class="panel-header">
                    <h3 id="slave-list-heading" class="panel-title">
                        <span class="panel-icon">üìã</span>
                        Configured Slaves (Sorted by ID)
                        <span class="badge" id="slaveCountBadge">0</span>
                    </h3>
                </header>

                <div class="table-container">
                    <table class="data-table" aria-describedby="slave-list-heading">
                        <thead>
                            <tr>
                                <th scope="col">Slave ID</th>
                                <th scope="col">Name</th>
                                <th scope="col">Start Reg</th>
                                <th scope="col">Count Reg</th>
                                <th scope="col">MQTT Topic</th>
                                <th scope="col">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="slavesTableBody">
                        </tbody>
                    </table>
                    <div class="empty-state" id="emptySlavesState">
                        <div class="empty-icon">üì≠</div>
                        <h4>No Slaves Configured</h4>
                        <p>Add your first Modbus slave device to get started</p>
                    </div>
                </div>
            </section>
            <!-- Add this after the existing slave list panel -->
            <section class="slave-stats-panel" aria-labelledby="slave-stats-heading">
                <header class="panel-header">
                    <h3 id="slave-stats-heading" class="panel-title">
                        <span class="panel-icon">üìä</span>
                        Query Statistics (Live)
                        <span class="badge" id="statsCountBadge">0</span>
                    </h3>
                </header>

                <div class="table-container">
                    <table class="data-table" aria-describedby="slave-stats-heading">
                        <thead>
                            <tr>
                                <th scope="col">Slave ID</th>
                                <th scope="col">Name</th>
                                <th scope="col">Total Queries</th>
                                <th scope="col">Success</th>
                                <th scope="col">Timeout</th>
                                <th scope="col">Failed</th>
                            </tr>
                        </thead>
                        <tbody id="statsTableBody">
                        </tbody>
                    </table>
                    <div class="empty-state" id="emptyStatsState">
                        <div class="empty-icon">üìä</div>
                        <h4>No Statistics Available</h4>
                        <p>Statistics will appear here as queries are executed</p>
                    </div>
                </div>
            </section>

            <!-- Info Panel -->
            <section class="config-panel" aria-labelledby="info-heading">
                <header class="panel-header">
                    <h3 id="info-heading" class="panel-title">
                        <span class="panel-icon">‚ÑπÔ∏è</span>
                        How to Use
                    </h3>
                </header>
                
                <div class="section-description">
                    <p><strong>Modbus Slave Configuration:</strong></p>
                    <p><strong>Step 1:</strong> Enter Slave ID  and descriptive Slave Name</p>
                    <p><strong>Step 2:</strong> Set Start Register address and Number of Registers</p>
                    <p><strong>Step 3:</strong> Select MQTT Topic for data publishing</p>
                    <p><strong>Step 4:</strong> Click "Add Slave Device" to add to configuration</p>
                    <p><strong>Step 5:</strong> Click "Save Slave" to confirm configuration and store into LittleFS file.</p>
                    <p><strong>Device Name Type:</strong>1)Sensor, 2)Meter, 3)Voltage, 4)Energy</p>
                    <p><strong>Note:</strong> When adding a new sensor, the Name has to have "Sensor" in it. Same to other type of devices. </p>
                    <br>
                    <p><strong>System Statistics:</strong></p>
                    <p><strong>Unique Slave IDs:</strong> Amount of different Slaves ID saved.</p>
                    <p><strong>Total Entries:</strong> Total amount of Slaves added.</p>
                    <br>
                    <p><strong>Global Settings:</strong></p>
                    <p><strong>Poll Interval:</strong> Set how often to query slaves (in seconds)</p>
                    <p><strong>Timeout:</strong> Set response timeout for slave devices (in seconds)</p>
                    <br>
                    <p><strong>Query Statistics:</strong></p>
                    <p><strong>Success:</strong> Able to send and receive query</p>
                    <p><strong>Timeout:</strong> Able to send query but did not receive message after x seconds</p>
                    <p><strong>Failed:</strong> Failed to send query at the start</p>
                    <br>
                    <p><strong>Note:</strong> Click "Load Slave", "Load Timeout", or "Load Poll Interval" to reload most recent saved settings</p>
                    <p><strong>Note:</strong> When deleting a slave, must click "Save Slave" to confirm the delete.</p>
                    
                    
                </div>
            </section>
        </main>

        <footer class="app-footer">
            <div class="footer-content">
                <!-- Empty footer as requested -->
            </div>
        </footer>
    </div>

    <script src="slaves.js"></script>
</body>
</html>